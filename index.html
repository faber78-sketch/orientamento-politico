<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Test di Orientamento Politico - 2025</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
  :root{--accent:#243447;--card:#fff;--bg:#f6f7fb}
  body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; background:var(--bg); color:#222;}
  header{background:var(--accent); color:#fff; padding:20px; text-align:center}
  main{max-width:1100px; margin:20px auto; padding:18px;}
  .intro{background:#eef6fb; border-left:6px solid var(--accent); padding:14px; border-radius:8px; margin-bottom:18px;}
  .area{background:var(--card); border-radius:8px; padding:14px; box-shadow:0 2px 8px rgba(0,0,0,0.06); margin-bottom:14px}
  .area h3{margin:0 0 10px 0; color:var(--accent)}
  .q{display:flex; flex-wrap:wrap; align-items:center; padding:8px 0; border-bottom:1px solid #f0f2f5}
  .q:last-child{border-bottom:0}
  .q p{margin:0; flex:1 1 60%}
  .selects{flex:0 0 36%; text-align:right}
  select{padding:8px;border-radius:6px;border:1px solid #ccd6df;background:#fff}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin:16px 0}
  button{background:var(--accent); color:#fff; padding:10px 14px; border:0;border-radius:8px; cursor:pointer}
  button.alt{background:#fff;color:var(--accent);border:1px solid #d7e0ea}
  #results{display:none;background:#f0faf0;border-left:6px solid #2d8f4f;padding:12px;border-radius:8px;margin-top:12px}
  .small{font-size:0.9em;color:#555}
  footer{text-align:center;margin:28px 0;color:#666;font-size:0.9em}
  @media (max-width:800px){
    .q p{flex-basis:100%; margin-bottom:8px}
    .selects{flex-basis:100%; text-align:left}
  }
</style>
</head>
<body>
<header>
  <h1>Test di Orientamento Politico 2025</h1>
</header>

<main>
  <div class="intro">
    <strong>Introduzione</strong>
    <p style="margin:6px 0 0">
      Questo test Ã¨ stato progettato per aiutarti a comprendere il tuo orientamento politico complessivo in modo scientifico e imparziale.
      Non si tratta di un sondaggio elettorale, ma di un profilo valoriale che analizza come le tue opinioni si distribuiscono lungo alcuni assi fondamentali del pensiero politico contemporaneo.
    </p>
    <p class="small" style="margin:6px 0 0">Durata stimata: 6â€“10 minuti â€” 81 affermazioni divise in 9 aree.</p>
  </div>

  <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px">
    <a href="metodi.html" target="_blank" class="small" style="color:var(--accent);text-decoration:none">ðŸ“˜ Metodi di riferimento</a>
    <div style="flex:1"></div>
    <button id="saveBtn" class="alt">Salva localmente</button>
    <button id="loadBtn" class="alt">Carica risposte salvate</button>
  </div>

  <form id="quiz"></form>

  <div class="controls">
    <button id="calcBtn">Calcola il profilo</button>
    <button id="shareBtn" class="alt">Genera link di condivisione</button>
    <button id="pdfBtn" class="alt">Scarica risultato (PDF)</button>
    <button id="resetBtn" class="alt">Reset</button>
  </div>

  <div id="results" aria-live="polite"></div>

  <footer>
    <div class="small">Â© 2025 Test Orientamento Politico â€” Uso didattico e divulgativo</div>
  </footer>
</main>

<script>
/* ========= DEFINIZIONE DELLE AREE E DELLE AFFERMAZIONI =========
 Each question object: {text: "...", dir: "R"|"L"|"N", id: "a1q1"}
 dir = "R" agreement â†’ Right (no inversion)
 dir = "L" agreement â†’ Left (invert with 6 - value)
 dir = "N" neutral (no inversion)
*/
const areas = [
  { id:1, title:"AREA 1 â€” ECONOMIA E LAVORO", qs:[
    {id:"1_1", text:"Lo Stato deve intervenire attivamente per ridistribuire la ricchezza e ridurre le disuguaglianze sociali.", dir:"L"},
    {id:"1_2", text:"Le tasse sui grandi patrimoni e sui profitti aziendali dovrebbero essere aumentate per finanziare servizi pubblici e welfare.", dir:"L"},
    {id:"1_3", text:"Le privatizzazioni di settori come autostrade, ferrovie o servizi pubblici hanno migliorato lâ€™efficienza economica del Paese.", dir:"R"},
    {id:"1_4", text:"Un salario minimo legale Ã¨ necessario per garantire una retribuzione dignitosa a tutti i lavoratori.", dir:"L"},
    {id:"1_5", text:"Le imprese dovrebbero avere meno vincoli sindacali e normativi per poter essere competitive a livello internazionale.", dir:"R"},
    {id:"1_6", text:"Le cooperative, le piccole e medie imprese e le imprese sociali dovrebbero essere favorite rispetto ai grandi gruppi industriali.", dir:"L"},
    {id:"1_7", text:"Gli incentivi alle aziende dovrebbero essere concessi solo se mantengono livelli stabili di occupazione.", dir:"L"},
    {id:"1_8", text:"Il mercato, e non lo Stato, deve determinare salari, prezzi e condizioni di lavoro.", dir:"R"},
    {id:"1_9", text:"In generale, lo Stato dovrebbe avere un ruolo forte nel garantire equilibrio e giustizia sociale.", dir:"L"}
  ]},

  { id:2, title:"AREA 2 â€” STATO, TASSE E WELFARE", qs:[
    {id:"2_1", text:"Lo Stato deve garantire sanitÃ  e istruzione gratuite e di alta qualitÃ  per tutti.", dir:"L"},
    {id:"2_2", text:"Chi guadagna di piÃ¹ dovrebbe contribuire con tasse proporzionalmente piÃ¹ alte.", dir:"L"},
    {id:"2_3", text:"Gli aiuti pubblici come il reddito di cittadinanza o i sussidi di disoccupazione rischiano di creare dipendenza e ridurre la voglia di lavorare.", dir:"R"},
    {id:"2_4", text:"Ãˆ giusto ridurre le tasse anche se ciÃ² comporta tagli ai servizi pubblici come sanitÃ , scuola o trasporti.", dir:"R"},
    {id:"2_5", text:"Misure come il reddito di cittadinanza sono strumenti efficaci per ridurre la povertÃ  e garantire una rete di protezione sociale.", dir:"L"},
    {id:"2_6", text:"I servizi pubblici dovrebbero essere gestiti da aziende private sotto controllo statale.", dir:"R"},
    {id:"2_7", text:"La spesa pubblica per la difesa dovrebbe aumentare.", dir:"R"},
    {id:"2_8", text:"La burocrazia Ã¨ un ostacolo maggiore rispetto alla mancanza di fondi.", dir:"R"},
    {id:"2_9", text:"In generale, lo Stato deve essere efficiente ma presente, capace di garantire equitÃ  senza frenare lâ€™iniziativa privata.", dir:"N"}
  ]},

  { id:3, title:"AREA 3 â€” EUROPA E POLITICA ESTERA", qs:[
    {id:"3_1", text:"Lâ€™Italia dovrebbe avere un ruolo piÃ¹ integrato e collaborativo nellâ€™Unione Europea.", dir:"L"},
    {id:"3_2", text:"Lâ€™Italia dovrebbe difendere la propria autonomia nelle decisioni europee, anche a costo di conflitti con Bruxelles.", dir:"R"},
    {id:"3_3", text:"Lâ€™Italia dovrebbe ridurre la propria dipendenza dalla NATO e puntare su una difesa europea autonoma.", dir:"L"},
    {id:"3_4", text:"Lâ€™Italia dovrebbe mantenere un forte legame politico, militare ed economico con gli Stati Uniti.", dir:"R"},
    {id:"3_5", text:"Le sanzioni economiche verso paesi autoritari sono uno strumento giusto ed efficace per difendere i diritti umani e la democrazia.", dir:"L"},
    {id:"3_6", text:"Lâ€™Italia dovrebbe continuare a commerciare con paesi autoritari se ciÃ² porta benefici economici rilevanti.", dir:"R"},
    {id:"3_7", text:"Lâ€™Unione Europea dovrebbe creare una forza di difesa comune.", dir:"L"},
    {id:"3_8", text:"Lâ€™Italia dovrebbe adottare politiche piÃ¹ restrittive sullâ€™immigrazione da paesi extra-UE.", dir:"R"},
    {id:"3_9", text:"In politica estera e di difesa, lâ€™Italia dovrebbe contare principalmente sulle istituzioni europee piuttosto che su decisioni nazionali autonome.", dir:"L"}
  ]},

  { id:4, title:"AREA 4 â€” AMBIENTE E SVILUPPO SOSTENIBILE", qs:[
    {id:"4_1", text:"Le politiche ambientali devono restare una prioritÃ  anche se comportano minore crescita economica.", dir:"L"},
    {id:"4_2", text:"Lâ€™energia nucleare rappresenta una soluzione sostenibile e realistica per ridurre le emissioni.", dir:"R"},
    {id:"4_3", text:"Le imprese piÃ¹ inquinanti dovrebbero pagare tasse ambientali piÃ¹ alte.", dir:"L"},
    {id:"4_4", text:"Lo Stato deve investire nelle energie rinnovabili e nella riconversione ecologica delle industrie.", dir:"L"},
    {id:"4_5", text:"Gli agricoltori dovrebbero ricevere sostegni economici per adottare pratiche piÃ¹ sostenibili.", dir:"L"},
    {id:"4_6", text:"Lâ€™ambiente Ã¨ spesso usato come pretesto per introdurre nuove tasse e limitazioni burocratiche.", dir:"R"},
    {id:"4_7", text:"I trasporti pubblici dovrebbero essere potenziati anche se ciÃ² limita l'uso dell'auto privata.", dir:"L"},
    {id:"4_8", text:"Le grandi opere infrastrutturali dovrebbero essere realizzate piÃ¹ rapidamente, anche se comportano impatto ambientale.", dir:"R"},
    {id:"4_9", text:"In generale, lo sviluppo economico dovrebbe prevalere sulla tutela ambientale quando i due obiettivi sono in conflitto.", dir:"R"}
  ]},

  { id:5, title:"AREA 5 â€” IMMIGRAZIONE E IDENTITÃ€", qs:[
    {id:"5_1", text:"Lâ€™immigrazione Ã¨ una risorsa economica e culturale per lâ€™Italia.", dir:"L"},
    {id:"5_2", text:"Lâ€™Italia deve accogliere solo chi ha effettivo diritto allâ€™asilo secondo le convenzioni internazionali.", dir:"R"},
    {id:"5_3", text:"Chi nasce in Italia da genitori stranieri regolari dovrebbe ottenere automaticamente la cittadinanza (ius soli).", dir:"L"},
    {id:"5_4", text:"Gli stranieri devono integrarsi rispettando la nostra cultura, le leggi e i valori fondamentali italiani.", dir:"R"},
    {id:"5_5", text:"Lâ€™Italia dovrebbe accogliere anche chi fugge da povertÃ  o instabilitÃ  politica, non solo chi ha diritto dâ€™asilo.", dir:"L"},
    {id:"5_6", text:"La presenza di immigrati aumenta il senso di insicurezza nella societÃ .", dir:"R"},
    {id:"5_7", text:"Lâ€™Italia deve contribuire a un sistema europeo di redistribuzione dei migranti.", dir:"L"},
    {id:"5_8", text:"Lâ€™identitÃ  italiana Ã¨ messa a rischio dalla diffusione della cucina etnica, del sushi o del kebab e dalla globalizzazione culturale.", dir:"R"},
    {id:"5_9", text:"In un Paese come lâ€™Italia, le politiche sullâ€™immigrazione dovrebbero concentrarsi piÃ¹ sulla difesa dellâ€™identitÃ  nazionale che sullâ€™inclusione culturale.", dir:"R"}
  ]},

  { id:6, title:"AREA 6 â€” GIUSTIZIA, SICUREZZA E LEGALITÃ€", qs:[
    {id:"6_1", text:"Le pene per reati gravi dovrebbero essere piÃ¹ severe e scontate interamente.", dir:"R"},
    {id:"6_2", text:"La certezza della pena Ã¨ piÃ¹ importante della rieducazione del detenuto.", dir:"R"},
    {id:"6_3", text:"Le leggi dello Stato dovrebbero ispirarsi ai valori religiosi o morali condivisi dalla maggioranza.", dir:"R"},
    {id:"6_4", text:"Lo Stato dovrebbe investire di piÃ¹ nella prevenzione sociale (scuola, lavoro, inclusione) piuttosto che nel carcere.", dir:"L"},
    {id:"6_5", text:"Le forze dellâ€™ordine dovrebbero avere maggiori poteri operativi anche a costo di ridurre alcune garanzie.", dir:"R"},
    {id:"6_6", text:"La giustizia dovrebbe essere piÃ¹ rapida, anche se questo comporta meno gradi di giudizio.", dir:"R"},
    {id:"6_7", text:"Chi commette reati economici (corruzione, frode, riciclaggio) dovrebbe ricevere pene severe equivalenti ai reati comuni.", dir:"L"},
    {id:"6_8", text:"I magistrati dovrebbero essere piÃ¹ controllati dal potere politico per evitare abusi.", dir:"R"},
    {id:"6_9", text:"In generale, nella giustizia italiana serve piÃ¹ ordine e controllo, anche se ciÃ² riduce un po' la libertÃ  individuale.", dir:"R"}
  ]},

  { id:7, title:"AREA 7 â€” ETICA, TECNOLOGIA E CULTURA", qs:[
    {id:"7_1", text:"Lâ€™intelligenza artificiale e le nuove tecnologie devono essere regolate dallo Stato per evitare abusi.", dir:"L"},
    {id:"7_2", text:"La religione cattolica dovrebbe avere un ruolo di riferimento nella cultura italiana e nella scuola pubblica.", dir:"R"},
    {id:"7_3", text:"Le fake news e la disinformazione online dovrebbero essere sanzionate, anche se ciÃ² comporta un maggiore controllo sui social network.", dir:"L"},
    {id:"7_4", text:"Lâ€™arte, la musica e la cultura dovrebbero ricevere piÃ¹ fondi pubblici.", dir:"L"},
    {id:"7_5", text:"La libertÃ  di espressione deve essere tutelata anche quando si tratta di opinioni estreme o offensive, purchÃ© non incitino alla violenza.", dir:"R"},
    {id:"7_6", text:"Le piattaforme digitali straniere dovrebbero pagare piÃ¹ tasse in Italia per contribuire ai servizi pubblici.", dir:"L"},
    {id:"7_7", text:"Le tradizioni locali e religiose vanno tutelate contro lâ€™omologazione globale.", dir:"R"},
    {id:"7_8", text:"La scienza deve prevalere su ogni credo religioso nelle decisioni pubbliche.", dir:"L"},
    {id:"7_9", text:"In generale, la cultura e la tecnologia dovrebbero essere usate per migliorare la societÃ , anche se ciÃ² richiede regole piÃ¹ rigide.", dir:"L"}
  ]},

  { id:8, title:"AREA 8 â€” INNOVAZIONE SOCIALE E FUTURO", qs:[
    {id:"8_1", text:"Il reddito di base universale Ã¨ una buona soluzione per il futuro del lavoro.", dir:"L"},
    {id:"8_2", text:"Le aziende che sostituiscono lavoratori con robot dovrebbero contribuire economicamente con una tassa sullâ€™automazione.", dir:"L"},
    {id:"8_3", text:"Le universitÃ  dovrebbero essere gratuite per gli studenti meritevoli ma con criteri severi di valutazione.", dir:"N"},
    {id:"8_4", text:"Le start-up e le imprese innovative dovrebbero ricevere piÃ¹ incentivi pubblici.", dir:"L"},
    {id:"8_5", text:"Il lavoro da remoto dovrebbe essere favorito anche nel settore pubblico.", dir:"L"},
    {id:"8_6", text:"Lâ€™intelligenza artificiale dovrebbe essere usata soprattutto per migliorare i servizi pubblici.", dir:"L"},
    {id:"8_7", text:"Le aziende dovrebbero pubblicare regolarmente lâ€™impatto ambientale e sociale delle proprie attivitÃ .", dir:"L"},
    {id:"8_8", text:"Le politiche per i giovani e la formazione dovrebbero avere prioritÃ  rispetto ad altri incentivi.", dir:"L"},
    {id:"8_9", text:"In generale, il progresso tecnologico e sociale deve essere guidato dallo Stato per garantire equitÃ .", dir:"L"}
  ]},

  { id:9, title:"AREA 9 â€” SINTESI FINALE (valori e percezioni)", qs:[
    {id:"9_1", text:"Mi riconosco in politiche che mettono al centro lâ€™uguaglianza sociale, anche a costo di ridurre i profitti privati.", dir:"L"},
    {id:"9_2", text:"La libertÃ  individuale e la riduzione del peso dello Stato sono piÃ¹ importanti dellâ€™intervento pubblico nellâ€™economia.", dir:"R"},
    {id:"9_3", text:"La cultura nazionale e le tradizioni devono essere difese anche a costo di limitare lâ€™influenza esterna.", dir:"R"},
    {id:"9_4", text:"Le trasformazioni tecnologiche e sociali vanno regolate per proteggere i piÃ¹ deboli e garantire coesione.", dir:"L"},
    {id:"9_5", text:"Le differenze di genere, etnia o orientamento sessuale devono essere tutelate con leggi specifiche.", dir:"L"},
    {id:"9_6", text:"La sicurezza e lâ€™ordine pubblico vengono prima delle libertÃ  individuali.", dir:"R"},
    {id:"9_7", text:"Le tasse sono un dovere civile necessario a mantenere servizi pubblici efficienti e accessibili.", dir:"L"},
    {id:"9_8", text:"Lo Stato deve ridurre la spesa pubblica e promuovere la responsabilitÃ  individuale.", dir:"R"},
    {id:"9_9", text:"Nel complesso, credo che il progresso del Paese debba essere guidato piÃ¹ dal mercato che dallo Stato.", dir:"R"}
  ]}
];

/* ===== render form ===== */
const quizForm = document.getElementById('quiz');

areas.forEach(area=>{
  const areaDiv = document.createElement('div');
  areaDiv.className = 'area';
  const h = document.createElement('h3'); h.textContent = area.title;
  areaDiv.appendChild(h);
  area.qs.forEach((q, idx)=>{
    const qdiv = document.createElement('div'); qdiv.className='q';
    const p = document.createElement('p'); p.innerHTML = `<strong>${idx+1}.</strong> ${q.text}`;
    qdiv.appendChild(p);
    const selWrap = document.createElement('div'); selWrap.className='selects';
    const select = document.createElement('select');
    select.name = q.id;
    const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent='Seleziona';
    select.appendChild(opt0);
    for(let v=1; v<=5; v++){
      const o = document.createElement('option'); o.value = v; o.textContent = v; select.appendChild(o);
    }
    selWrap.appendChild(select);
    qdiv.appendChild(selWrap);
    areaDiv.appendChild(qdiv);
  });
  quizForm.appendChild(areaDiv);
});

/* ===== utilities ===== */
function readAnswers() {
  const data = {};
  areas.forEach(area=>{
    area.qs.forEach(q=>{
      const val = document.querySelector(`[name="${q.id}"]`)?.value;
      data[q.id] = val ? +val : null;
    });
  });
  return data;
}
function allAnswered() {
  const a = readAnswers();
  return Object.values(a).every(v=>v!==null);
}
function invertIfNeeded(val, dir){
  // val is integer 1..5
  if (dir === 'L') return 6 - val; // invert: agreement left -> lower right score
  return val; // 'R' and 'N' unchanged
}

/* ===== calculate results ===== */
function calculateAll() {
  const answers = readAnswers();
  // validate at least one answered
  const answeredCount = Object.values(answers).filter(v=>v!==null).length;
  if(answeredCount === 0) { alert('Rispondi ad almeno una domanda prima di calcolare il profilo.'); return null; }

  const areaScores = [];
  areas.forEach(area=>{
    let sum = 0, count = 0;
    area.qs.forEach(q=>{
      const v = answers[q.id];
      if (v !== null) {
        const score = invertIfNeeded(v, q.dir); // higher = more right
        sum += score;
        count++;
      }
    });
    const avgRaw = count>0 ? (sum / count) : null; // 1..5 range (aligned to right)
    // normalize area to 0..100 where 0 = extreme left, 100 = extreme right
    const normalized = avgRaw === null ? null : Math.round(((avgRaw - 1) / 4) * 100);
    areaScores.push({areaId: area.id, avgRaw, normalized, answered: count});
  });

  // overall: weighted average by number of answered items per area
  let totalWeighted = 0, totalWeight = 0;
  areaScores.forEach(a=>{
    if (a.avgRaw !== null) {
      totalWeighted += a.avgRaw * a.answered;
      totalWeight += a.answered;
    }
  });
  const overallAvg = totalWeight>0 ? (totalWeighted / totalWeight) : null;
  const overallNorm = overallAvg === null ? null : Math.round(((overallAvg -1)/4)*100);

  return {answers, areaScores, overallAvg, overallNorm};
}

/* ===== render / UI actions ===== */
const resultsDiv = document.getElementById('results');
document.getElementById('calcBtn').addEventListener('click', (e)=>{
  e.preventDefault();
  const res = calculateAll();
  if(!res) return;
  // determine profile by overallNorm
  const n = res.overallNorm;
  let profile = '';
  if (n === null) profile = 'Non determinato';
  else if (n <= 20) profile = 'Sinistra progressista';
  else if (n <= 40) profile = 'Centro-sinistra / Riformista';
  else if (n <= 60) profile = 'Centro / Moderato';
  else if (n <= 80) profile = 'Centro-destra / Liberale-Conservatore';
  else profile = 'Destra conservatrice / Sovranista';

  // build html
  let html = `<h3>Profilo stimato: <strong>${profile}</strong></h3>`;
  html += `<p>Punteggio complessivo (0=sinistra | 100=destra): <strong>${res.overallNorm}</strong></p>`;
  html += `<div style="margin-top:8px"><strong>Riepilogo per area (0=sinistra â†’ 100=destra):</strong><ul>`;
  res.areaScores.forEach(a=>{
    const title = areas.find(x=>x.id===a.areaId).title;
    const scoreText = a.normalized===null ? 'N/D' : a.normalized;
    html += `<li style="margin:6px 0"><strong>${title}</strong>: ${scoreText} (domande compilate: ${a.answered})</li>`;
  });
  html += `</ul></div>`;
  resultsDiv.innerHTML = html;
  resultsDiv.style.display = 'block';
});

document.getElementById('resetBtn').addEventListener('click', (e)=>{
  e.preventDefault();
  if(!confirm('Vuoi resettare tutte le risposte?')) return;
  document.querySelectorAll('select').forEach(s=>s.value='');
  resultsDiv.style.display='none';
  localStorage.removeItem('qp_saved');
});

document.getElementById('saveBtn').addEventListener('click', (e)=>{
  e.preventDefault();
  const data = readAnswers();
  localStorage.setItem('qp_saved', JSON.stringify(data));
  alert('Risposte salvate localmente nel browser.');
});

document.getElementById('loadBtn').addEventListener('click', (e)=>{
  e.preventDefault();
  const raw = localStorage.getItem('qp_saved');
  if(!raw){ alert('Nessuna risposta salvata trovata.'); return; }
  try {
    const obj = JSON.parse(raw);
    Object.keys(obj).forEach(k=>{
      const el = document.querySelector(`[name="${k}"]`);
      if(el && obj[k] !== null) el.value = obj[k];
    });
    alert('Risposte caricate.');
  } catch(err){ alert('Errore nel caricamento.'); }
});

/* ===== share link generation =====
 We encode answers object as JSON then base64-url encode to keep link compact.
*/
function base64UrlEncode(str){
  return btoa(unescape(encodeURIComponent(str))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
function base64UrlDecode(b64){
  return decodeURIComponent(escape(atob(b64.replace(/-/g,'+').replace(/_/g,'/'))));
}

document.getElementById('shareBtn').addEventListener('click', (e)=>{
  e.preventDefault();
  const res = calculateAll();
  if(!res) return;
  const payload = {
    v:1,
    t: Date.now(),
    a: res.answers
  };
  const b64 = base64UrlEncode(JSON.stringify(payload));
  const short = b64.slice(0, 20); // optional human preview
  const url = `${location.origin}${location.pathname}#r=${b64}`;
  // copy to clipboard
  navigator.clipboard?.writeText(url).then(()=>{
    alert('Link generato e copiato negli appunti. Puoi condividerlo.\n(Se vuoi conservarlo, copia il link manualmente.)');
  }).catch(()=>{ prompt('Copia questo link:', url); });
});

/* ===== on load: if hash present, decode and fill ===== */
function loadFromHash(){
  const h = location.hash || '';
  if(!h.startsWith('#r=')) return;
  const b64 = h.slice(3);
  try{
    const obj = JSON.parse(base64UrlDecode(b64));
    if(obj && obj.a){
      Object.keys(obj.a).forEach(k=>{
        const el = document.querySelector(`[name="${k}"]`);
        if(el && obj.a[k] !== null) el.value = obj.a[k];
      });
      // auto calculate
      document.getElementById('calcBtn').click();
    }
  }catch(err){
    console.warn('hash load error', err);
  }
}
window.addEventListener('load', loadFromHash);

/* ===== PDF export via jsPDF (minimal) ===== */
document.getElementById('pdfBtn').addEventListener('click', async (e)=>{
  e.preventDefault();
  const res = calculateAll();
  if(!res) return;
  // load jsPDF if needed
  if(typeof window.jspdf === 'undefined'){
    await new Promise((ok, no)=> {
      const s = document.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
      s.onload = ok; s.onerror = no;
      document.head.appendChild(s);
    }).catch(()=>{ alert('Impossibile caricare libreria PDF.'); return; });
  }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(12);
  doc.text('Risultato Test Orientamento Politico', 14, 20);
  doc.setFontSize(10);
  doc.text(`Data: ${new Date().toLocaleString()}`, 14, 28);
  doc.text(`Punteggio globale: ${res.overallNorm}`, 14, 36);
  // add area summary
  let y = 46;
  res.areaScores.forEach(a=>{
    const title = areas.find(x=>x.id===a.areaId).title;
    const scoreText = a.normalized===null ? 'N/D' : a.normalized;
    const line = `${title}: ${scoreText} (risposte ${a.answered})`;
    if(y>270){ doc.addPage(); y=20; }
    doc.text(line, 14, y); y+=6;
  });
  doc.save('profilo_politico.pdf');
});

</script>
</body>
</html>
